---
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';
import Panel from "../components/Panel.astro";
import Sidebar from "../components/Sidebar.astro";
import TableOfContents from "../components/TableOfContents.astro";
import { Image } from 'astro:assets';
import {SITE_LANGUAGE, SITE_TITLE} from "../consts.ts";

type Props = CollectionEntry<'blog'>['data'] & {
	headings?: { depth: number; slug: string; text: string }[];
};

const { title, description, pubDate, updatedDate, heroImage, headings = [], categories, tags } = Astro.props;
const showToc = headings.filter(h => h.depth >= 2 && h.depth <= 3).length > 0;
---

<html lang={SITE_LANGUAGE}>
<head>
	<BaseHead title={title + " - " + SITE_TITLE} description={description} />
</head>

<body class="flex flex-col min-h-screen">
<Header />

<div class="w-full px-4 mt-16 grow">
	<div class="mx-auto max-w-[95%] md:max-w-[80%]">
		<div class="flex flex-col-reverse lg:flex-row gap-8">

			<!-- Left Sidebar: Profile + TOC -->
			<aside class="lg:w-1/4 min-w-0">
				<Sidebar hasToc={showToc}>
					{showToc && (
						<Panel class="p-5! max-h-[calc(100vh-10rem)] overflow-y-auto custom-scrollbar">
							<TableOfContents headings={headings} />
						</Panel>
					)}
				</Sidebar>
			</aside>

			<!-- Main Content -->
			<article class="w-full lg:w-3/4 min-w-0">
				<Panel class="px-6 py-8 md:px-10 md:py-12">
					{/* Hero Image */}
					<div class="w-full mb-8">
						{heroImage ? (
							<Image width={1020} height={510} src={heroImage} alt="" class="rounded-xl shadow-lg w-full object-cover max-h-125" />
						) : (
							<div class="w-full h-8 bg-linear-to-r from-zinc-100 to-zinc-50 dark:from-white/5 dark:to-white/0 rounded-t-xl mb-4"></div>
						)}
					</div>

					{/* Header */}
					<div class="mb-10 text-center border-b border-zinc-200 dark:border-white/10 pb-8">
						{categories && categories.length > 0 && (
							<div class="flex justify-center gap-2 mb-4">
								{categories.map(cat => (
									<a href={`/archive?category=${encodeURIComponent(cat)}`} class="text-xs font-bold uppercase tracking-wider text-blue-600 dark:text-blue-400 border border-blue-200 dark:border-blue-800/50 px-3 py-1 rounded-full hover:bg-blue-50 dark:hover:bg-blue-900/30 transition-colors">
										{cat}
									</a>
								))}
							</div>
						)}

						<h1 class="text-3xl md:text-5xl font-bold mb-6 leading-tight text-zinc-900 dark:text-zinc-100">{title}</h1>

						<div class="flex flex-wrap items-center justify-center gap-6 text-sm text-zinc-500 dark:text-zinc-400">
							<div class="flex items-center gap-2">
								<i class="fa-regular fa-calendar"></i>
								<FormattedDate date={pubDate} />
							</div>
							{updatedDate && (
								<div class="flex items-center gap-2 text-zinc-400" title="Last Updated">
									<i class="fa-solid fa-rotate-right"></i>
									<FormattedDate date={updatedDate} />
								</div>
							)}
						</div>
					</div>

					{/* Content */}
					<div class="prose dark:prose-invert max-w-none prose-lg">
						<slot />
					</div>

					{/* Tags */}
					{tags && tags.length > 0 && (
						<div class="mt-12 pt-6 border-t border-zinc-200 dark:border-white/10">
							<div class="flex items-center gap-3">
								<i class="fa-solid fa-tags text-zinc-400"></i>
								<div class="flex flex-wrap gap-2">
									{tags.map(tag => (
										<a href={`/archive?tag=${encodeURIComponent(tag)}`} class="text-sm px-3 py-1 bg-zinc-100 dark:bg-white/5 rounded-lg text-zinc-600 dark:text-zinc-400 hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors">
											#{tag}
										</a>
									))}
								</div>
							</div>
						</div>
					)}
				</Panel>
			</article>

		</div>
	</div>
</div>

<!-- Lightbox Container -->
<div id="lightbox">
	<img id="lightbox-img" src="" alt="Enlarged view" />
</div>

<Footer />

<script>
	// --- Code Block Copy & Lightbox Logic ---
	document.addEventListener('astro:page-load', () => {

		// 1. Copy Code Button
		const codeBlocks = document.querySelectorAll('pre');
		codeBlocks.forEach((pre) => {
			// Check if button already exists (client router navigation)
			if (pre.querySelector('.copy-code-btn')) return;

			const button = document.createElement('button');
			button.className = 'copy-code-btn';
			button.innerHTML = '<i class="fa-regular fa-copy"></i>'; // Copy

			button.addEventListener('click', async () => {
				const code = pre.querySelector('code')?.innerText;
				if (!code) return;

				try {
					await navigator.clipboard.writeText(code);
					button.innerHTML = '<i class="fa-solid fa-check"></i>';// Copied!
					setTimeout(() => {
						button.innerHTML = '<i class="fa-regular fa-copy"></i>'; // Copy
					}, 2000);
				} catch (err) {
					console.error('Failed to copy:', err);
					button.innerHTML = 'Error';
				}
			});

			pre.appendChild(button);
		});

		// 2. Image Lightbox
		const images = document.querySelectorAll('.prose img');
		const lightbox = document.getElementById('lightbox');
		const lightboxImg = document.getElementById('lightbox-img') as HTMLImageElement;

		if (lightbox && lightboxImg) {
			images.forEach((img) => {
				img.addEventListener('click', () => {
					lightboxImg.src = (img as HTMLImageElement).src;
					lightbox.classList.add('active');
				});
			});

			lightbox.addEventListener('click', (e) => {
				if (e.target !== lightboxImg) {
					lightbox.classList.remove('active');
				}
			});
		}
	});
</script>
</body>
</html>
