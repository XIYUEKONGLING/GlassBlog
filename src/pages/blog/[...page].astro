---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';
import Panel from "../../components/Panel.astro";
import Profile from "../../components/Profile.astro";
import FormattedDate from '../../components/FormattedDate.astro';
import {SITE_DESCRIPTION, SITE_PAGESIZE, SITE_TITLE} from '../../consts';
import type { Page } from 'astro';

export async function getStaticPaths({ paginate }: { paginate: any }) {
	const posts = (await getCollection('blog')).sort(
		(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
	);
	return paginate(posts, { pageSize: SITE_PAGESIZE });
}

const { page } = Astro.props as { page: Page };
const posts = page.data;

const allPosts = await getCollection('blog');
const categories = [...new Set(allPosts.flatMap((post) => post.data.categories || []))].sort();
const tags = [...new Set(allPosts.flatMap((post) => post.data.tags || []))].sort();
---

<!doctype html>
<html lang="en">
<head>
	<BaseHead title={"Blog - " + SITE_TITLE} description={SITE_DESCRIPTION} />
</head>
<body class="flex flex-col min-h-screen">
<Header />
<div class="w-full px-4 mt-16 grow">
	<div class="mx-auto max-w-[95%] md:max-w-[80%]">
		<div class="flex flex-col lg:flex-row gap-8">

			<!-- Left Sidebar: Profile + Filters -->
			<aside class="lg:w-1/4">
				<div class="sticky top-28 flex flex-col gap-6">
					<Profile />

					<!-- Search Widget (Filters current page visibly) -->
					<Panel class="p-6!">
						<div class="relative">
							<i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-zinc-400 text-sm"></i>
							<label for="search-input"></label><input
								type="text"
								id="search-input"
								placeholder="Filter current page..."
								class="w-full bg-black/5 dark:bg-white/10 border border-transparent focus:border-blue-500 rounded-xl pl-10 pr-4 py-2 outline-none transition-all placeholder:text-zinc-400 text-sm"
							/>
						</div>
					</Panel>

					<!-- Global Categories -->
					{categories.length > 0 && (
						<Panel class="p-6!">
							<h3 class="font-bold text-sm text-zinc-400 uppercase tracking-wider mb-3 flex items-center gap-2">
								<i class="fa-solid fa-folder"></i> Categories
							</h3>
							<ul class="flex flex-col gap-1 text-sm">
								{categories.map(category => (
									<li>
										<a href={`/archive#category-${category}`} class="flex justify-between items-center px-2 py-1.5 rounded hover:bg-black/5 dark:hover:bg-white/10 text-zinc-600 dark:text-zinc-400 transition-colors">
											<span>{category}</span>
											<span class="text-xs opacity-50 bg-zinc-100 dark:bg-white/5 px-1.5 rounded-full">
                                                {allPosts.filter(p => p.data.categories?.includes(category)).length}
                                            </span>
										</a>
									</li>
								))}
							</ul>
						</Panel>
					)}

					<!-- Global Tags -->
					{tags.length > 0 && (
						<Panel class="p-6!">
							<h3 class="font-bold text-sm text-zinc-400 uppercase tracking-wider mb-3 flex items-center gap-2">
								<i class="fa-solid fa-tags"></i> Tags
							</h3>
							<div class="flex flex-wrap gap-2">
								{tags.map(tag => (
									<a href={`/archive#tag-${tag}`} class="text-xs px-2.5 py-1 bg-black/5 dark:bg-white/10 rounded-md hover:bg-blue-100 dark:hover:bg-blue-900/30 text-zinc-600 dark:text-zinc-400 transition-colors">
										#{tag}
									</a>
								))}
							</div>
						</Panel>
					)}
				</div>
			</aside>

			<!-- Right Content: Paginated List -->
			<main class="lg:w-3/4">
				<Panel>
					<div class="flex flex-col gap-8" id="post-list">
						{posts.map((post) => (
							<article class="post-item flex flex-col md:flex-row gap-6 border-b border-zinc-200/50 dark:border-white/5 pb-8 last:border-0 last:pb-0">

								{/* 1. Image Column (Only if image exists) */}
								{post.data.heroImage && (
									<a href={`/blog/${post.id}/`} class="w-full md:w-1/3 shrink-0 overflow-hidden rounded-2xl group">
										<Image
											width={720}
											height={360}
											src={post.data.heroImage}
											alt=""
											class="w-full h-48 md:h-full object-cover transition-transform duration-500 group-hover:scale-110"
										/>
									</a>
								)}

								{/* 2. Content Column */}
								<div class="flex flex-col justify-center grow">
									{/* Meta Header */}
									<div class="text-sm text-zinc-500 dark:text-zinc-400 mb-2 flex flex-wrap items-center gap-x-4 gap-y-2">
                                        <span class="flex items-center gap-1.5" title="Published Date">
                                            <i class="fa-regular fa-calendar-days text-xs opacity-70"></i>
                                            <FormattedDate date={post.data.pubDate} />
                                        </span>

										{post.data.categories && post.data.categories.length > 0 && (
											<span class="flex items-center gap-1.5 text-blue-600 dark:text-blue-400">
                                                <i class="fa-regular fa-folder text-xs opacity-70"></i>
                                                <span class="font-medium">{post.data.categories[0]}</span>
                                            </span>
										)}
									</div>

									<a href={`/blog/${post.id}/`} class="group">
										<h2 class="text-2xl font-bold mb-3 text-zinc-900 dark:text-zinc-100 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
											{post.data.title}
										</h2>
									</a>

									<p class="text-zinc-600 dark:text-zinc-400 leading-relaxed line-clamp-3 mb-4">
										{post.data.description}
									</p>

									{/* Tags Footer */}
									{post.data.tags && post.data.tags.length > 0 && (
										<div class="flex flex-wrap gap-2">
											{post.data.tags.map((tag: string) => (
												<span class="text-xs text-zinc-400 dark:text-zinc-500 hover:text-zinc-600 dark:hover:text-zinc-300 transition-colors cursor-default">
                                                    #{tag}
                                                </span>
											))}
										</div>
									)}
								</div>
							</article>
						))}
					</div>

					<!-- Pagination Controls -->
					<div class="mt-12 pt-6 border-t border-zinc-200 dark:border-white/10 flex justify-between items-center">
						{page.url.prev ? (
							<a href={page.url.prev} class="flex items-center gap-2 px-4 py-2 rounded-lg bg-zinc-100 dark:bg-white/5 hover:bg-zinc-200 dark:hover:bg-white/10 text-sm font-medium transition-colors">
								<i class="fa-solid fa-arrow-left"></i> Previous
							</a>
						) : <div></div>}

						<span class="text-sm text-zinc-400">
                            Page {page.currentPage} of {page.lastPage}
                        </span>

						{page.url.next ? (
							<a href={page.url.next} class="flex items-center gap-2 px-4 py-2 rounded-lg bg-zinc-100 dark:bg-white/5 hover:bg-zinc-200 dark:hover:bg-white/10 text-sm font-medium transition-colors">
								Next <i class="fa-solid fa-arrow-right"></i>
							</a>
						) : <div></div>}
					</div>
				</Panel>
			</main>
		</div>
	</div>
</div>
<Footer />

<script>
	// Simple filter for visible posts on current page
	const searchInput = document.getElementById('search-input') as HTMLInputElement;
	const items = document.querySelectorAll('.post-item');

	searchInput?.addEventListener('input', (e) => {
		const term = (e.target as HTMLInputElement).value.toLowerCase();
		items.forEach((item) => {
			const el = item as HTMLElement;
			const content = el.innerText.toLowerCase();
			if (content.includes(term)) {
				el.style.display = 'flex';
			} else {
				el.style.display = 'none';
			}
		});
	});
</script>
</body>
</html>
