---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';
import Panel from "../../components/Panel.astro";
import Profile from "../../components/Profile.astro";
import FormattedDate from '../../components/FormattedDate.astro';
import {SITE_DESCRIPTION, SITE_PAGESIZE, SITE_TITLE} from '../../consts';
import type { Page } from 'astro';

export async function getStaticPaths({ paginate }: { paginate: any }) {
	const posts = (await getCollection('blog')).sort(
		(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
	);
	return paginate(posts, { pageSize: SITE_PAGESIZE });
}

const { page } = Astro.props as { page: Page };
const posts = page.data;

const allPosts = await getCollection('blog');
const categories = [...new Set(allPosts.flatMap((post) => post.data.categories || []))].sort();
const tags = [...new Set(allPosts.flatMap((post) => post.data.tags || []))].sort();
---

<!doctype html>
<html lang="en">
<head>
	<BaseHead title={"Blog - " + SITE_TITLE} description={SITE_DESCRIPTION} />
</head>
<body class="flex flex-col min-h-screen">
<Header />
<div class="w-full px-4 mt-16 grow">
	<div class="mx-auto max-w-[95%] md:max-w-[80%]">
		<div class="flex flex-col lg:flex-row gap-8">

			<!-- Left Sidebar: Profile + Simple Stats (Moved search away) -->
			<aside class="lg:w-1/4">
				<div class="sticky top-28 flex flex-col gap-6">
					<Profile />

					<!-- Stats Panel -->
					<Panel class="p-6! flex flex-col gap-4 text-sm text-zinc-600 dark:text-zinc-400">
						<div class="flex justify-between items-center">
							<span>Total Posts</span>
							<span class="font-bold text-zinc-900 dark:text-zinc-100">{allPosts.length}</span>
						</div>
						<div class="flex justify-between items-center">
							<span>Categories</span>
							<span class="font-bold text-zinc-900 dark:text-zinc-100">{categories.length}</span>
						</div>
						<div class="flex justify-between items-center">
							<span>Tags</span>
							<span class="font-bold text-zinc-900 dark:text-zinc-100">{tags.length}</span>
						</div>
					</Panel>
				</div>
			</aside>

			<!-- Right Content: Main List -->
			<main class="lg:w-3/4">
				<Panel>
					<!-- Search Input Moved Here (UX Improvement) -->
					<div class="mb-8 relative z-10">
						<div class="relative group">
							<i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-zinc-400 group-focus-within:text-blue-500 transition-colors"></i>
							<label for="search-input"></label><input
								type="text"
								id="search-input"
								placeholder="Filter articles on this page..."
								class="w-full bg-zinc-100/50 dark:bg-black/20 border border-zinc-200 dark:border-white/10 rounded-2xl pl-11 pr-4 py-3 outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all text-zinc-800 dark:text-zinc-200 placeholder:text-zinc-400"
							/>
						</div>
					</div>

					<div class="flex flex-col gap-8" id="post-list">
						{posts.map((post) => (
							<article class="post-item flex flex-col md:flex-row gap-6 border-b border-zinc-200/50 dark:border-white/5 pb-8 last:border-0 last:pb-0">

								{/* Image Column */}
								{post.data.heroImage && (
									<a href={`/blog/${post.id}/`} class="w-full md:w-1/3 shrink-0 overflow-hidden rounded-2xl group/img">
										<Image
											width={720}
											height={360}
											src={post.data.heroImage}
											alt=""
											class="w-full h-48 md:h-full object-cover transition-transform duration-700 group-hover/img:scale-110"
										/>
									</a>
								)}

								{/* Content Column */}
								<div class="flex flex-col justify-center grow min-w-0">
									{/* Meta Header */}
									<div class="text-sm text-zinc-500 dark:text-zinc-400 mb-2 flex flex-wrap items-center gap-x-4 gap-y-2">
                                        <span class="flex items-center gap-1.5" title="Published Date">
                                            <i class="fa-regular fa-calendar-days text-xs opacity-70"></i>
                                            <FormattedDate date={post.data.pubDate} />
                                        </span>

										<!-- Categories Fix: Show up to 3 -->
										{post.data.categories && post.data.categories.length > 0 && (
											<div class="flex items-center gap-2">
												<i class="fa-regular fa-folder text-xs opacity-70"></i>
												<div class="flex flex-wrap gap-1">
													{post.data.categories.slice(0, 3).map((cat: string): unknown => (
														<a href={`/archive#category-${cat}`} class="text-blue-600 dark:text-blue-400 hover:underline decoration-blue-400/30 underline-offset-2">
															{cat}
														</a>
													))}
													{post.data.categories.length > 3 && <span>...</span>}
												</div>
											</div>
										)}
									</div>

									<a href={`/blog/${post.id}/`} class="group/title block mb-3">
										<h2 class="text-2xl font-bold text-zinc-900 dark:text-zinc-100 group-hover/title:text-blue-600 dark:group-hover/title:text-blue-400 transition-colors">
											{post.data.title}
										</h2>
									</a>

									<p class="text-zinc-600 dark:text-zinc-400 leading-relaxed line-clamp-2 mb-4">
										{post.data.description}
									</p>

									{/* Tags Footer */}
									{post.data.tags && post.data.tags.length > 0 && (
										<div class="flex flex-wrap gap-2">
											{post.data.tags.slice(0, 5).map((tag: string) => (
												<span class="text-xs px-2 py-1 bg-zinc-100 dark:bg-white/5 rounded text-zinc-500 dark:text-zinc-400">
                                                    #{tag}
                                                </span>
											))}
										</div>
									)}
								</div>
							</article>
						))}
					</div>

					<!-- Pagination Controls -->
					<div class="mt-12 pt-6 border-t border-zinc-200 dark:border-white/10 flex justify-between items-center">
						{page.url.prev ? (
							<a href={page.url.prev} class="flex items-center gap-2 px-4 py-2 rounded-lg bg-zinc-100 dark:bg-white/5 hover:bg-zinc-200 dark:hover:bg-white/10 text-sm font-medium transition-colors">
								<i class="fa-solid fa-arrow-left"></i> Previous
							</a>
						) : <div></div>}

						<span class="text-sm text-zinc-400">
                            Page {page.currentPage} of {page.lastPage}
                        </span>

						{page.url.next ? (
							<a href={page.url.next} class="flex items-center gap-2 px-4 py-2 rounded-lg bg-zinc-100 dark:bg-white/5 hover:bg-zinc-200 dark:hover:bg-white/10 text-sm font-medium transition-colors">
								Next <i class="fa-solid fa-arrow-right"></i>
							</a>
						) : <div></div>}
					</div>
				</Panel>
			</main>
		</div>
	</div>
</div>
<Footer />

<script>
	document.addEventListener('astro:page-load', () => {
		const searchInput = document.getElementById('search-input') as HTMLInputElement;
		const items = document.querySelectorAll('.post-item');

		if(searchInput) {
			searchInput.addEventListener('input', (e) => {
				const term = (e.target as HTMLInputElement).value.toLowerCase();
				items.forEach((item) => {
					const el = item as HTMLElement;
					const content = el.innerText.toLowerCase();
					if (content.includes(term)) {
						el.style.display = 'flex';
					} else {
						el.style.display = 'none';
					}
				});
			});
		}
	});
</script>
</body>
</html>
