---
import { getCollection } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import Panel from "../components/Panel.astro";
import Profile from "../components/Profile.astro";
import FormattedDate from '../components/FormattedDate.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';

const posts = (await getCollection('blog')).sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// Group by Year
const postsByYear = posts.reduce((acc, post) => {
    const year = post.data.pubDate.getFullYear();
    if (!acc[year]) acc[year] = [];
    acc[year].push(post);
    return acc;
}, {} as Record<number, typeof posts>);

const years = Object.keys(postsByYear).sort((a, b) => Number(b) - Number(a));
---

<!doctype html>
<html lang="en">
<head>
    <BaseHead title={"Archive - " + SITE_TITLE} description={SITE_DESCRIPTION} />
</head>
<body class="flex flex-col min-h-screen">
<Header />
<div class="w-full px-4 mt-16 grow">
    <div class="mx-auto max-w-[95%] md:max-w-[80%]">
        <div class="flex flex-col lg:flex-row gap-8">

            <!-- Left Sidebar: Just Profile -->
            <aside class="lg:w-1/4">
                <div class="sticky top-28">
                    <Profile />
                </div>
            </aside>

            <!-- Right Content: Timeline Archive -->
            <main class="lg:w-3/4">
                <Panel>
                    <h1 class="text-3xl font-bold mb-8 flex items-center gap-3 text-zinc-800 dark:text-zinc-100">
                        <i class="fa-solid fa-box-archive text-zinc-400"></i>
                        Archive
                    </h1>

                    <div class="space-y-10 relative border-l border-zinc-200 dark:border-white/10 ml-3 md:ml-6 pl-6 md:pl-8 py-2">
                        {years.map(year => (
                                <div class="relative">
                                    {/* Year Marker */}
                                    <span class="absolute -left-[3.2rem] md:-left-[3.7rem] top-0 flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900/50 border border-blue-200 dark:border-blue-700/30 text-blue-600 dark:text-blue-300 text-xs font-bold ring-4 ring-white dark:ring-[#1a1b26]">
                                    {year}
                                </span>

                                    <div class="space-y-6">
                                        {postsByYear[Number(year)].map(post => (
                                                <article class="group relative flex flex-col sm:flex-row gap-2 sm:gap-4 sm:items-baseline transition-all">

                                                    {/* Date */}
                                                    <div class="shrink-0 w-24 text-sm text-zinc-400 font-mono pt-1">
                                                        {post.data.pubDate.toLocaleDateString('en-US', { month: 'short', day: '2-digit' })}
                                                    </div>

                                                    {/* Title & Meta */}
                                                    <div class="grow pb-4 border-b border-zinc-100 dark:border-white/5 group-last:border-0">
                                                        <a href={`/blog/${post.id}/`} class="block text-lg font-bold text-zinc-800 dark:text-zinc-200 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors mb-1">
                                                            {post.data.title}
                                                        </a>

                                                        <div class="flex flex-wrap items-center gap-3 text-xs text-zinc-500 dark:text-zinc-500">
                                                            {post.data.categories && (
                                                                    <span class="flex items-center gap-1">
                                                            <i class="fa-regular fa-folder"></i>
                                                                        {post.data.categories[0]}
                                                        </span>
                                                            )}

                                                            {post.data.tags && (
                                                                    <span class="flex items-center gap-2">
                                                            <i class="fa-solid fa-hashtag opacity-50"></i>
                                                                        {post.data.tags.slice(0, 3).join(', ')}
                                                        </span>
                                                            )}
                                                        </div>
                                                    </div>
                                                </article>
                                        ))}
                                    </div>
                                </div>
                        ))}
                    </div>
                </Panel>
            </main>
        </div>
    </div>
</div>
<Footer />
</body>
</html>
