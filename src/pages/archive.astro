---
import { getCollection } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import Panel from "../components/Panel.astro";
import Sidebar from "../components/Sidebar.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';

const posts = (await getCollection('blog')).sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

const postsByYear = posts.reduce((acc, post) => {
    const year = post.data.pubDate.getFullYear();
    if (!acc[year]) acc[year] = [];
    acc[year].push(post);
    return acc;
}, {} as Record<number, typeof posts>);

const years = Object.keys(postsByYear).sort((a, b) => Number(b) - Number(a));
---

<!DOCTYPE HTML>
<html lang="en">
<head>
    <BaseHead title={"Archive - " + SITE_TITLE} description={SITE_DESCRIPTION} />
</head>
<body class="flex flex-col min-h-screen">
<Header />
<div class="w-full px-4 mt-16 grow">
    <div class="mx-auto max-w-[95%] md:max-w-[80%]">
        <div class="flex flex-col lg:flex-row gap-8">

            <aside class="lg:w-1/4">
                <Sidebar>
                    <!-- Sidebar Filters Control -->
                    <Panel class="p-5! text-sm hidden" id="active-filter-panel">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-zinc-900 dark:text-zinc-100">Active Filter</h3>
                            <button id="reset-filter" class="text-xs text-blue-600 dark:text-blue-400 hover:underline">Clear</button>
                        </div>
                        <div id="filter-status" class="mt-2 text-zinc-600 dark:text-zinc-400 wrap-break-word font-mono text-xs bg-zinc-100 dark:bg-white/5 p-2 rounded"></div>
                    </Panel>
                </Sidebar>
            </aside>

            <main class="lg:w-3/4">
                <Panel>
                    <div class="flex items-center justify-between mb-8 border-b border-zinc-200 dark:border-white/10 pb-4">
                        <h1 class="text-3xl font-bold flex items-center gap-3 text-zinc-800 dark:text-zinc-100">
                            <i class="fa-solid fa-box-archive text-zinc-400"></i>
                            Archive
                        </h1>
                        <span id="post-count" class="text-zinc-500 text-sm">{posts.length} posts</span>
                    </div>

                    <div id="archive-container" class="space-y-8">
                        {years.map(year => (
                                <div class="year-section animate-fade-in-up" data-year={year}>
                                    <h2 class="text-2xl font-bold text-zinc-300 dark:text-white/20 mb-4 select-none border-l-4 border-blue-500/50 pl-4">
                                        {year}
                                    </h2>

                                    <div class="flex flex-col">
                                        {postsByYear[Number(year)].map((post, index) => (
                                                <article
                                                        class="archive-item flex flex-col sm:flex-row gap-2 sm:gap-6 py-4 border-b border-zinc-200/50 dark:border-white/5 last:border-0 hover:bg-zinc-50/50 dark:hover:bg-white/[0.02] transition-colors rounded-lg px-2"
                                                        data-categories={post.data.categories?.join(',') || ''}
                                                        data-tags={post.data.tags?.join(',') || ''}
                                                >
                                                    <div class="w-16 sm:w-20 shrink-0 text-sm text-zinc-400 dark:text-zinc-500 font-mono pt-1">
                                                        {post.data.pubDate.toLocaleDateString('en-US', { month: 'short', day: '2-digit' })}
                                                    </div>

                                                    <div class="grow min-w-0">
                                                        <a href={`/blog/${post.id}/`} class="block text-lg font-bold text-zinc-800 dark:text-zinc-200 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors mb-1">
                                                            {post.data.title}
                                                        </a>

                                                        <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-xs text-zinc-500">
                                                            {post.data.categories && (
                                                                    <div class="flex items-center gap-1.5">
                                                                        {post.data.categories.map(c => (
                                                                                <span class="bg-blue-50 dark:bg-blue-900/10 text-blue-600 dark:text-blue-400 px-1.5 py-0.5 rounded border border-blue-100 dark:border-blue-900/30">
                                                                    {c}
                                                                </span>
                                                                        ))}
                                                                    </div>
                                                            )}

                                                            {post.data.tags && (
                                                                    <div class="flex items-center gap-2 opacity-60">
                                                                        <i class="fa-solid fa-hashtag text-[10px]"></i>
                                                                        <span>{post.data.tags.join(', ')}</span>
                                                                    </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                </article>
                                        ))}
                                    </div>
                                </div>
                        ))}
                    </div>

                    <div id="no-results" class="hidden py-20 text-center text-zinc-500">
                        <i class="fa-regular fa-folder-open text-4xl mb-4 opacity-50"></i>
                        <p>No posts found for this filter.</p>
                    </div>
                </Panel>
            </main>
        </div>
    </div>
</div>
<Footer />

<script>
    document.addEventListener('astro:page-load', () => {
        const items = document.querySelectorAll('.archive-item');
        const yearSections = document.querySelectorAll('.year-section');
        const resetBtn = document.getElementById('reset-filter');
        const activeFilterPanel = document.getElementById('active-filter-panel');
        const filterStatus = document.getElementById('filter-status');
        const noResults = document.getElementById('no-results');
        const postCount = document.getElementById('post-count');

        // Check URL hash for filter
        const checkHash = () => {
            const hash = window.location.hash; // e.g., #category-Tech
            if (hash) {
                const [type, val] = hash.replace('#', '').split('-');
                if (type && val) {
                    applyFilter(type, decodeURIComponent(val));
                }
            }
        };

        function applyFilter(type: string, value: string) {
            let visibleCount = 0;

            // Show Active Filter Panel
            if (activeFilterPanel && filterStatus) {
                activeFilterPanel.classList.remove('hidden');
                filterStatus.textContent = `${type}: ${value}`;
            }

            items.forEach(item => {
                const el = item as HTMLElement;
                const categories = el.dataset.categories?.split(',') || [];
                const tags = el.dataset.tags?.split(',') || [];
                let match = false;

                if (type === 'category') match = categories.includes(value);
                if (type === 'tag') match = tags.includes(value);

                if (match) {
                    el.style.display = 'flex';
                    visibleCount++;
                } else {
                    el.style.display = 'none';
                }
            });

            // Hide Empty Years
            yearSections.forEach(section => {
                const visibleItems = (section as HTMLElement).querySelectorAll('.archive-item[style="display: flex;"]');
                (section as HTMLElement).style.display = visibleItems.length > 0 ? 'block' : 'none';
            });

            if (noResults) noResults.style.display = visibleCount === 0 ? 'block' : 'none';
            if (postCount) postCount.textContent = `${visibleCount} posts found`;
        }

        function reset() {
            items.forEach(el => (el as HTMLElement).style.display = 'flex');
            yearSections.forEach(el => (el as HTMLElement).style.display = 'block');

            if (activeFilterPanel) activeFilterPanel.classList.add('hidden');

            if (noResults) noResults.style.display = 'none';
            if (postCount) postCount.textContent = `${items.length} posts`;

            // Remove hash without scrolling
            history.pushState("", document.title, window.location.pathname + window.location.search);
        }

        resetBtn?.addEventListener('click', reset);

        // Listen for hash changes (clicking sidebar links does not trigger page reload)
        window.addEventListener('hashchange', checkHash);

        // Initial check
        checkHash();
    });
</script>
</body>
</html>
